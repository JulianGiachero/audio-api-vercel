var S=Object.defineProperty;var I=(a,e,t)=>e in a?S(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var s=(a,e,t)=>I(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();class C{constructor(){s(this,"queue",[])}enqueue(e){this.queue.push(e)}dequeue(){return this.queue.shift()}peek(){return this.queue[0]}clear(){this.queue.length=0}get length(){return this.queue.length}toArray(){return[...this.queue]}}class v{constructor(e){s(this,"context",null);s(this,"mediaStream",null);s(this,"mediaNode",null);s(this,"gainNode",null);s(this,"compressor",null);s(this,"blockQueue",new C);s(this,"blockSeconds",5);s(this,"sampleRate",44100);s(this,"recording",!1);s(this,"capturing",!1);s(this,"captureBuffer",null);s(this,"captureOffset",0);s(this,"scriptNode",null);s(this,"nextBlockId",1);s(this,"lastScheduledEnd",0);s(this,"onStatus");s(this,"onQueueUpdate");s(this,"getParams");this.onStatus=e.onStatus,this.onQueueUpdate=e.onQueueUpdate,this.getParams=e.getParams}async init(){if(!this.context){this.context=new AudioContext({sampleRate:this.sampleRate,latencyHint:"interactive"});try{const e=new URL("data:video/mp2t;base64,Ly8gUGhhc2Ugdm9jb2RlciBwbGFjZWhvbGRlci4gRm9yIE1WUCwgd2Ugd29uJ3QgZG8gdGltZS1zdHJldGNoIGhlcmUuCi8vIFRoaXMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIGNhbiBiZSBleHRlbmRlZCBpbiBJdGVyYXRpb24gMi4KCmNsYXNzIFBhc3N0aHJvdWdoUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBvdmVycmlkZSBwcm9jZXNzKGlucHV0czogRmxvYXQzMkFycmF5W11bXSwgb3V0cHV0czogRmxvYXQzMkFycmF5W11bXSk6IGJvb2xlYW4gewogICAgY29uc3QgaW5wdXQgPSBpbnB1dHNbMF07CiAgICBjb25zdCBvdXRwdXQgPSBvdXRwdXRzWzBdOwogICAgaWYgKCFpbnB1dCB8fCAhb3V0cHV0KSByZXR1cm4gdHJ1ZTsKICAgIGNvbnN0IGlucHV0Q2hhbm5lbCA9IGlucHV0WzBdOwogICAgY29uc3Qgb3V0cHV0Q2hhbm5lbCA9IG91dHB1dFswXTsKICAgIGlmICghaW5wdXRDaGFubmVsIHx8ICFvdXRwdXRDaGFubmVsKSByZXR1cm4gdHJ1ZTsKICAgIGNvbnN0IGluMCA9IGlucHV0Q2hhbm5lbDsKICAgIGNvbnN0IG91dDAgPSBvdXRwdXRDaGFubmVsOwogICAgY29uc3QgZnJhbWVzID0gTWF0aC5taW4oaW4wLmxlbmd0aCwgb3V0MC5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZXM7IGkrKykgewogICAgICBvdXQwW2ldID0gaW4wW2ldOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9CgpyZWdpc3RlclByb2Nlc3NvcigncGFzc3Rocm91Z2gtcHJvY2Vzc29yJywgUGFzc3Rocm91Z2hQcm9jZXNzb3IpOwoK",import.meta.url);await this.context.audioWorklet.addModule(e)}catch(e){console.warn("AudioWorklet no cargado (MVP continúa con ScriptProcessorNode):",e)}}}async start(e){this.blockSeconds=Math.max(2,Math.min(10,Math.floor(e))),this.onStatus({state:"requesting-permission",queueLength:this.blockQueue.length,message:"Solicitando permisos…"}),await this.init();const t=this.context,n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1,sampleRate:this.sampleRate}});this.mediaStream=n,this.mediaNode=t.createMediaStreamSource(n),this.gainNode=t.createGain(),this.compressor=t.createDynamicsCompressor(),this.compressor.threshold.value=-6,this.compressor.knee.value=12,this.compressor.ratio.value=3,this.compressor.attack.value=.003,this.compressor.release.value=.25;const o=2048;this.scriptNode=t.createScriptProcessor(o,1,1),this.mediaNode.connect(this.scriptNode),this.scriptNode.connect(t.destination);const i=this.blockSeconds*this.sampleRate;this.captureBuffer=new Float32Array(i),this.captureOffset=0,this.capturing=!0,this.recording=!0,this.scriptNode.onaudioprocess=r=>{if(!this.capturing||!this.captureBuffer)return;const h=r.inputBuffer.getChannelData(0);let c=0;for(;c<h.length;){const m=this.captureBuffer.length-this.captureOffset,u=Math.min(m,h.length-c);if(this.captureBuffer.set(h.subarray(c,c+u),this.captureOffset),this.captureOffset+=u,c+=u,this.captureOffset>=this.captureBuffer.length){const g={id:this.nextBlockId++,ts:performance.now(),pcm:this.captureBuffer,sampleRate:this.sampleRate};this.blockQueue.enqueue(g),this.onQueueUpdate(this.blockQueue.length),this.captureBuffer=new Float32Array(this.blockSeconds*this.sampleRate),this.captureOffset=0,this.scheduleNextIfPossible()}}},this.onStatus({state:"recording",queueLength:this.blockQueue.length,message:`Grabación OK, encolando bloques… Bloque=${this.blockSeconds}s`})}stop(){if(this.recording=!1,this.capturing=!1,this.scriptNode&&(this.scriptNode.disconnect(),this.scriptNode.onaudioprocess=null,this.scriptNode=null),this.mediaNode&&(this.mediaNode.disconnect(),this.mediaNode=null),this.mediaStream){for(const e of this.mediaStream.getTracks())e.stop();this.mediaStream=null}this.blockQueue.clear(),this.onQueueUpdate(0),this.lastScheduledEnd=0,this.onStatus({state:"stopped",queueLength:0,message:"Detenido"})}scheduleNextIfPossible(){const e=this.context;if(!e||!this.recording)return;const t=.2;for(;this.blockQueue.length>0&&(this.lastScheduledEnd===0||this.lastScheduledEnd<e.currentTime+t);){const n=this.blockQueue.dequeue();this.onQueueUpdate(this.blockQueue.length);const{gain:o,speed:i}=this.getParams(),r=e.createBuffer(1,n.pcm.length,n.sampleRate);r.getChannelData(0).set(n.pcm);const c=e.createBufferSource();c.buffer=r,c.playbackRate.value=i;const m=e.createGain();m.gain.value=Math.max(0,o);const u=e.createDynamicsCompressor();u.threshold.value=-3,u.knee.value=18,u.ratio.value=2.5,u.attack.value=.002,u.release.value=.2,c.connect(m).connect(u).connect(e.destination);const g=e.currentTime,f=r.duration/i,p=Math.max(g+.05,this.lastScheduledEnd||g+.05);c.start(p);const b=p+f;this.lastScheduledEnd=b,c.onended=()=>{this.scheduleNextIfPossible()},this.onStatus({state:"recording",queueLength:this.blockQueue.length,message:`Reproducción secuencial: programado bloque #${n.id}`})}}setBlockSeconds(e){const t=Math.max(2,Math.min(10,Math.floor(e)));this.blockSeconds=t}}class B{constructor(){s(this,"statusEl",document.getElementById("status"));s(this,"queueCountEl",document.getElementById("queueCount"));s(this,"queueViewEl",document.getElementById("queueView"));s(this,"btnStart",document.getElementById("btnStart"));s(this,"btnStop",document.getElementById("btnStop"));s(this,"speedInput",document.getElementById("speed"));s(this,"speedVal",document.getElementById("speedVal"));s(this,"volumeInput",document.getElementById("volume"));s(this,"volumeVal",document.getElementById("volumeVal"));s(this,"blockSelect",document.getElementById("block"))}bindStart(e){this.btnStart.onclick=()=>{const t=parseInt(this.blockSelect.value,10)||5;e(t),this.btnStart.disabled=!0,this.btnStop.disabled=!1}}bindStop(e){this.btnStop.onclick=()=>{e(),this.btnStart.disabled=!1,this.btnStop.disabled=!0}}getParams(){const e=parseFloat(this.speedInput.value),t=parseFloat(this.volumeInput.value),n=parseInt(this.blockSelect.value,10)||5;return{speed:e,gain:t,blockSizeSeconds:n}}onSpeedChange(e){const t=()=>{const n=parseFloat(this.speedInput.value);this.speedVal.textContent=`${n.toFixed(2)}×`,e(n)};this.speedInput.addEventListener("input",t),t()}onVolumeChange(e){const t=()=>{const n=parseFloat(this.volumeInput.value);this.volumeVal.textContent=`${n.toFixed(2)}×`,e(n)};this.volumeInput.addEventListener("input",t),t()}onBlockChange(e){const t=()=>{const n=parseInt(this.blockSelect.value,10)||5;e(n)};this.blockSelect.addEventListener("change",t)}setStatus(e){e.message&&(this.statusEl.textContent=e.message)}setQueueLength(e){this.queueCountEl.textContent=`${e}`,this.queueViewEl.innerHTML="";for(let t=0;t<e;t++){const n=document.createElement("div");n.className="bar",n.style.height=`${12+t%3*6}px`,this.queueViewEl.appendChild(n)}}}const l=new B;let d=null;function k(){return d||(d=new v({onStatus:a=>l.setStatus(a),onQueueUpdate:a=>l.setQueueLength(a),getParams:()=>l.getParams()})),d}l.onSpeedChange(()=>{});l.onVolumeChange(()=>{});l.onBlockChange(a=>{d&&d.setBlockSeconds(a)});l.bindStart(async a=>{try{await k().start(a)}catch(e){console.error(e),l.setStatus({state:"error",queueLength:0,message:"Error al iniciar: revisar permisos de micrófono"})}});l.bindStop(()=>{d&&d.stop()});
